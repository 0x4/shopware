<?xml version="1.0" ?>
<project name="Shopware dbDeploy" basedir="../" default="build">
    <!-- Load our configuration -->
    <property name="basedir" value="${project.basedir}"/>
    <property file="${basedir}/_build/build.properties"/>

    <!-- load the dbdeploy task -->
    <taskdef name="dbdeploy" classname="phing.tasks.ext.dbdeploy.DbDeployTask"/>

    <!-- create our migration task -->
    <target name="init" description="Initialize the Changelog and the scripts">
        <!-- import changelog table if not exist-->
       <exec
            command="${script.mysql} -h${db.host} -u${db.user} -p${db.password} ${db.name} &lt; ${build.dir}/dbdeploy.install.sql"
            dir="${build.dir}"
            checkreturn="true" error="${build.dir}/error.log"/>
    </target>

    <target name="deploy" description="Initialize the Changelog and the scripts">
    	<echo msg="${sql.dir}/deltas"/>
        <dbdeploy
            url="mysql:host=${db.host};dbname=${db.name}"
            userid="${db.user}"
            password="${db.password}"
            dir="${sql.dir}/deltas"
            outputfile="${build.database.deployfile}"
            undooutputfile="${build.database.undofile}"/>
    </target>

    <!-- create our migration task -->
    <target name="build" description="Database Migrations" depends="init,deploy">
        <echo msg="${script.mysql} -h${db.host} -u${db.user} -p${db.password} ${db.name} &lt; ${build.database.deployfile}"/>
        <!-- execute the SQL - Use mysql command line to avoid trouble with large files or many statements and PDO -->
        <exec
                command="${script.mysql} -h${db.host} -u${db.user} -p${db.password} --default-character-set=utf8 ${db.name} &lt; ${build.database.deployfile}"
                dir="${build.dir}"
                checkreturn="true" error="${build.dir}/error.log"/>
    </target>


    <!-- create our migration task -->
    <target name="undo" description="Database Migrations" depends="build">
        <!-- delete existing scripts -->
        <delete>
            <fileset dir="${sql.dir}/scripts">
                <include name="*.sql"/>
            </fileset>
        </delete>

        <!-- truncate the changelog table -->
        <echo msg="${script.mysql} -h${db.host} -u${db.user} -p${db.password} ${db.name} &lt; ${build.dir}/dbdeploy.truncate.sql"/>
        <exec
                command="${script.mysql} -h${db.host} -u${db.user} -p${db.password} ${db.name} &lt; ${build.dir}/dbdeploy.truncate.sql"
                dir="${build.dir}"
                checkreturn="true" error="${build.dir}/error.log"/>
        <dbdeploy
                url="mysql:host=${db.host};dbname=${db.name}"
                userid="${db.user}"
                password="${db.password}"
                dir="${sql.dir}/deltas"
                outputfile="${build.database.deployfile}"
                undooutputfile="${build.database.undofile}"/>

        <echo msg="${script.mysql} -h${db.host} -u${db.user} -p${db.password} ${db.name} &lt; ${build.database.undofile}"/>
        <!-- execute the SQL - Use mysql command line to avoid trouble with large files or many statements and PDO -->
        <exec
                command="${script.mysql} -h${db.host} -u${db.user} -p${db.password} ${db.name} &lt; ${build.database.undofile}"
                dir="${build.dir}"
                checkreturn="true" error="${build.dir}/error.log"/>

        <!-- delete existing scripts -->
        <delete>
            <fileset dir="${sql.dir}/scripts">
                <include name="*.sql"/>
            </fileset>
        </delete>
    </target>
</project>
